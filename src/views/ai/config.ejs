<%- include('../partials/head') %>
<%- include('../partials/navbar') %>

<main class="p-4 sm:p-6 lg:p-8">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Configuracion IA</h1>
      <p class="text-sm text-gray-500 mt-1">Protocolos de llamadas automaticas con inteligencia artificial</p>
    </div>

    <div class="flex items-center gap-3 flex-wrap">
      <!-- Boton ejecutar deteccion manualmente -->
      <button id="btn-run-detection" onclick="runDetection()"
              class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
        </svg>
        Detectar paros ahora
      </button>

      <!-- Enlace a historial -->
      <a href="/ai/calls"
         class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
        </svg>
        Historial llamadas
      </a>
    </div>
  </div>

  <!-- Tarjetas de estadisticas -->
  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
    <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
      <p class="text-xs text-gray-500 uppercase tracking-wider">Viajes con IA</p>
      <p id="stat-ia-active" class="text-2xl font-bold text-purple-600 mt-1"><%= viajesConIA || 0 %></p>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
      <p class="text-xs text-gray-500 uppercase tracking-wider">Llamadas hoy</p>
      <p id="stat-calls-today" class="text-2xl font-bold text-gray-900 mt-1"><%= stats.total_calls || 0 %></p>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
      <p class="text-xs text-gray-500 uppercase tracking-wider">Atendidas hoy</p>
      <p id="stat-answered" class="text-2xl font-bold text-emerald-600 mt-1"><%= stats.atendidas || 0 %></p>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
      <p class="text-xs text-gray-500 uppercase tracking-wider">No atendidas</p>
      <p id="stat-unanswered" class="text-2xl font-bold text-amber-600 mt-1"><%= stats.no_atendidas || 0 %></p>
    </div>
    <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
      <p class="text-xs text-gray-500 uppercase tracking-wider">Errores</p>
      <p id="stat-errors" class="text-2xl font-bold text-red-600 mt-1"><%= stats.errores || 0 %></p>
    </div>
  </div>

  <!-- Tabs: Viajes con IA / Protocolos -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6">
    <div class="border-b border-gray-200">
      <nav class="flex -mb-px" id="ai-tabs">
        <button onclick="switchTab('trips')" id="tab-trips"
                class="px-6 py-3 text-sm font-medium border-b-2 border-purple-500 text-purple-600 focus:outline-none">
          <svg class="w-4 h-4 mr-1.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
          </svg>
          Viajes con IA
        </button>
        <button onclick="switchTab('protocols')" id="tab-protocols"
                class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none">
          <svg class="w-4 h-4 mr-1.5 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          Protocolos
        </button>
      </nav>
    </div>

    <!-- Tab: Viajes con IA -->
    <div id="panel-trips">
      <!-- Filtro solo con IA -->
      <div class="p-4 border-b border-gray-100 bg-gray-50/50">
        <label class="inline-flex items-center cursor-pointer">
          <input type="checkbox" id="filter-solo-ia" onchange="refreshTripsGrid()" class="sr-only peer">
          <div class="relative w-9 h-5 bg-gray-300 peer-focus:ring-2 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div>
          <span class="ml-2 text-sm text-gray-600">Mostrar solo viajes con IA activa</span>
        </label>
      </div>
      <div id="tripsGrid"></div>
    </div>

    <!-- Tab: Protocolos -->
    <div id="panel-protocols" class="hidden">
      <div class="p-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
        <p class="text-sm text-gray-600">Protocolos de comunicacion para llamadas IA</p>
        <button onclick="showProtocolDialog()"
                class="inline-flex items-center px-3 py-1.5 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors">
          <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          Nuevo protocolo
        </button>
      </div>
      <div id="protocolsList" class="p-4">
        <div class="text-center text-gray-400 py-8">Cargando protocolos...</div>
      </div>
    </div>
  </div>

  <!-- Dialog editar config IA de viaje -->
  <div id="tripConfigDialog" style="display:none;">
    <div class="p-4 space-y-4">
      <input type="hidden" id="edit-trip-id">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Viaje</label>
        <p id="edit-trip-label" class="text-sm text-gray-900 font-medium"></p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Llamadas IA activas</label>
        <label class="inline-flex items-center cursor-pointer">
          <input type="checkbox" id="edit-ia-active" class="sr-only peer">
          <div class="relative w-11 h-6 bg-gray-300 peer-focus:ring-2 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[3px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
          <span class="ml-2 text-sm text-gray-600">Activar llamadas automaticas por IA</span>
        </label>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Umbral de paro (minutos)</label>
        <input type="number" id="edit-umbral" min="5" max="120" value="30"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
        <p class="text-xs text-gray-400 mt-1">Tiempo detenido para activar alerta y llamadas (5-120 min)</p>
      </div>
    </div>
  </div>

  <!-- Dialog protocolo IA -->
  <div id="protocolDialog" style="display:none;">
    <div class="p-4 space-y-4">
      <input type="hidden" id="proto-id">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Viaje asociado (opcional)</label>
        <select id="proto-viaje"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
          <option value="">Protocolo default (todos los viajes)</option>
          <% (viajes || []).forEach(function(v) { %>
            <option value="<%= v.id %>">#<%= v.id %> - <%= v.origen %> → <%= v.destino %></option>
          <% }); %>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Umbral de paro (minutos)</label>
        <input type="number" id="proto-umbral" min="5" max="120" value="30"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Llamadas activas</label>
        <label class="inline-flex items-center cursor-pointer">
          <input type="checkbox" id="proto-llamadas" class="sr-only peer" checked>
          <div class="relative w-11 h-6 bg-gray-300 peer-focus:ring-2 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[3px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
          <span class="ml-2 text-sm text-gray-600">Habilitar llamadas automaticas</span>
        </label>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Idioma</label>
        <select id="proto-idioma"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
          <option value="es">Espanol</option>
          <option value="en">Ingles</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Protocolo personalizado (texto para la IA)</label>
        <textarea id="proto-texto" rows="5" placeholder="Instrucciones especificas para el asistente de voz IA..."
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-y"></textarea>
        <p class="text-xs text-gray-400 mt-1">Opcional. Instrucciones que la IA seguira al hacer las llamadas.</p>
      </div>
    </div>
  </div>
</main>

<%- include('../partials/foot') %>

<script>
(function() {
  // ===========================================================================
  // Tabs
  // ===========================================================================

  window.switchTab = function(tab) {
    var tabs = ['trips', 'protocols'];
    tabs.forEach(function(t) {
      var tabEl = document.getElementById('tab-' + t);
      var panelEl = document.getElementById('panel-' + t);
      if (t === tab) {
        tabEl.className = 'px-6 py-3 text-sm font-medium border-b-2 border-purple-500 text-purple-600 focus:outline-none';
        panelEl.classList.remove('hidden');
      } else {
        tabEl.className = 'px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 focus:outline-none';
        panelEl.classList.add('hidden');
      }
    });

    if (tab === 'protocols') loadProtocols();
  };

  // ===========================================================================
  // Syncfusion Grid: Viajes con config IA
  // ===========================================================================

  function buildTripsUrl() {
    var base = '/ai/api/trips';
    var soloIA = document.getElementById('filter-solo-ia').checked;
    return soloIA ? base + '?soloIA=true' : base;
  }

  // Template para toggle IA
  function iaToggleTemplate(props) {
    var active = props.ia_llamadas_activas;
    var colorClass = active ? 'bg-purple-600' : 'bg-gray-300';
    var dotPos = active ? 'translate-x-5' : 'translate-x-0';
    var label = active ? 'Activa' : 'Inactiva';
    var labelColor = active ? 'text-purple-600 font-medium' : 'text-gray-400';

    return '<div class="flex items-center gap-2">' +
      '<button onclick="toggleIA(' + props.id + ', event)" class="relative inline-flex h-5 w-10 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out ' + colorClass + '">' +
      '<span class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform duration-200 ease-in-out ' + dotPos + '"></span>' +
      '</button>' +
      '<span class="text-xs ' + labelColor + '">' + label + '</span>' +
      '</div>';
  }

  // Template para umbral
  function umbralTemplate(props) {
    var val = props.umbral_paro_minutos || 30;
    return '<span class="font-medium">' + val + ' min</span>';
  }

  // Template para estado
  function estadoTemplate(props) {
    var estado = props.estado_actual || 'desconocido';
    var colors = {
      en_ruta: 'bg-blue-100 text-blue-800',
      programado: 'bg-amber-100 text-amber-800',
      en_carga: 'bg-purple-100 text-purple-800',
      completado: 'bg-emerald-100 text-emerald-800',
      cancelado: 'bg-red-100 text-red-800',
    };
    var colorClass = colors[estado] || 'bg-gray-100 text-gray-800';
    var labels = {
      en_ruta: 'En ruta',
      programado: 'Programado',
      en_carga: 'En carga',
      completado: 'Completado',
      cancelado: 'Cancelado',
    };
    return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + colorClass + '">' +
      (labels[estado] || estado) + '</span>';
  }

  // Template para llamadas
  function llamadasTemplate(props) {
    var total = props.total_llamadas || 0;
    if (total === 0) return '<span class="text-gray-400">-</span>';
    return '<span class="font-medium text-purple-600">' + total + '</span>';
  }

  // Template para acciones
  function accionesTemplate(props) {
    return '<div class="flex items-center gap-1">' +
      '<button onclick="editTripConfig(' + props.id + ', event)" class="p-1.5 text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" title="Configurar IA">' +
      '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>' +
      '</button>' +
      '</div>';
  }

  var tripsGrid = new ej.grids.Grid({
    dataSource: new ej.data.DataManager({
      url: buildTripsUrl(),
      adaptor: new ej.data.UrlAdaptor(),
      crossDomain: false,
    }),
    allowPaging: true,
    allowSorting: true,
    allowResizing: true,
    pageSettings: { pageSize: 15, pageSizes: [10, 15, 30, 50] },
    gridLines: 'Horizontal',
    rowHeight: 48,
    enableHover: true,
    columns: [
      { field: 'id', headerText: 'ID', width: 70, textAlign: 'Right', isPrimaryKey: true },
      {
        field: 'id_unidad',
        headerText: 'Unidad',
        width: 100,
        template: function(props) {
          return '<span class="font-medium text-gray-800">' + (props.id_unidad || '-') + '</span>';
        },
      },
      {
        field: 'origen',
        headerText: 'Ruta',
        width: 200,
        clipMode: 'EllipsisWithTooltip',
        template: function(props) {
          return '<div class="text-xs">' +
            '<span class="text-gray-600">' + (props.origen || '?') + '</span>' +
            ' <span class="text-gray-400">→</span> ' +
            '<span class="text-gray-800 font-medium">' + (props.destino || '?') + '</span>' +
            '</div>';
        },
      },
      {
        field: 'estado_actual',
        headerText: 'Estado',
        width: 110,
        textAlign: 'Center',
        template: function(props) { return estadoTemplate(props); },
      },
      {
        field: 'ia_llamadas_activas',
        headerText: 'IA Activa',
        width: 120,
        textAlign: 'Center',
        template: function(props) { return iaToggleTemplate(props); },
      },
      {
        field: 'umbral_paro_minutos',
        headerText: 'Umbral paro',
        width: 110,
        textAlign: 'Center',
        template: function(props) { return umbralTemplate(props); },
      },
      {
        field: 'total_llamadas',
        headerText: 'Llamadas',
        width: 90,
        textAlign: 'Center',
        template: function(props) { return llamadasTemplate(props); },
      },
      {
        field: 'ultima_llamada',
        headerText: 'Ultima llamada',
        width: 140,
        template: function(props) {
          if (!props.ultima_llamada) return '<span class="text-gray-400">-</span>';
          var d = new Date(props.ultima_llamada);
          return '<span class="text-xs" title="' + d.toISOString() + '">' +
            d.toLocaleDateString('es-MX', { day: '2-digit', month: 'short' }) + ' ' +
            d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' }) +
            '</span>';
        },
      },
      {
        headerText: '',
        width: 60,
        textAlign: 'Center',
        allowSorting: false,
        template: function(props) { return accionesTemplate(props); },
      },
    ],
  });

  tripsGrid.appendTo('#tripsGrid');

  window.refreshTripsGrid = function() {
    tripsGrid.dataSource = new ej.data.DataManager({
      url: buildTripsUrl(),
      adaptor: new ej.data.UrlAdaptor(),
      crossDomain: false,
    });
  };

  // ===========================================================================
  // Toggle IA para un viaje
  // ===========================================================================

  window.toggleIA = function(tripId, event) {
    if (event) { event.stopPropagation(); event.preventDefault(); }

    fetch('/ai/api/toggle/' + tripId, { method: 'POST' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          refreshTripsGrid();
          loadStats();
          showToast(data.message, 'success');
        } else {
          showToast('Error: ' + (data.error || 'Error desconocido'), 'error');
        }
      })
      .catch(function(err) {
        showToast('Error: ' + err.message, 'error');
      });
  };

  // ===========================================================================
  // Dialog: Editar config IA de viaje
  // ===========================================================================

  var tripConfigDlg = new ej.popups.Dialog({
    header: 'Configurar IA del viaje',
    content: document.getElementById('tripConfigDialog'),
    showCloseIcon: true,
    isModal: true,
    width: '480px',
    visible: false,
    animationSettings: { effect: 'Zoom' },
    buttons: [
      {
        buttonModel: { content: 'Guardar', isPrimary: true, cssClass: 'e-primary' },
        click: function() { saveTripConfig(); },
      },
      {
        buttonModel: { content: 'Cancelar' },
        click: function() { tripConfigDlg.hide(); },
      },
    ],
  });
  tripConfigDlg.appendTo('#tripConfigDialog');

  window.editTripConfig = function(tripId, event) {
    if (event) { event.stopPropagation(); event.preventDefault(); }

    // Buscar datos del viaje en el grid
    var gridData = tripsGrid.currentViewData || [];
    var trip = null;
    for (var i = 0; i < gridData.length; i++) {
      if (gridData[i].id === tripId) { trip = gridData[i]; break; }
    }

    if (!trip) {
      showToast('No se encontraron datos del viaje', 'error');
      return;
    }

    document.getElementById('edit-trip-id').value = trip.id;
    document.getElementById('edit-trip-label').textContent =
      '#' + trip.id + ' - ' + (trip.origen || '?') + ' → ' + (trip.destino || '?');
    document.getElementById('edit-ia-active').checked = !!trip.ia_llamadas_activas;
    document.getElementById('edit-umbral').value = trip.umbral_paro_minutos || 30;

    tripConfigDlg.show();
  };

  window.saveTripConfig = function() {
    var tripId = document.getElementById('edit-trip-id').value;
    var iaActive = document.getElementById('edit-ia-active').checked;
    var umbral = parseInt(document.getElementById('edit-umbral').value) || 30;

    fetch('/ai/api/update-trip/' + tripId, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        ia_llamadas_activas: iaActive,
        umbral_paro_minutos: umbral,
      }),
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        tripConfigDlg.hide();
        refreshTripsGrid();
        loadStats();
        showToast('Configuracion actualizada', 'success');
      } else {
        showToast('Error: ' + (data.error || 'Error desconocido'), 'error');
      }
    })
    .catch(function(err) {
      showToast('Error: ' + err.message, 'error');
    });
  };

  // ===========================================================================
  // Protocolos IA
  // ===========================================================================

  window.loadProtocols = function() {
    var container = document.getElementById('protocolsList');
    container.innerHTML = '<div class="text-center text-gray-400 py-8">Cargando protocolos...</div>';

    fetch('/ai/api/protocols')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (!data.success || !data.data || data.data.length === 0) {
          container.innerHTML = '<div class="text-center py-8">' +
            '<svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>' +
            '</svg>' +
            '<p class="text-gray-500 text-sm">No hay protocolos configurados</p>' +
            '<p class="text-gray-400 text-xs mt-1">Crea un protocolo para personalizar las llamadas IA</p>' +
            '</div>';
          return;
        }

        var html = '<div class="space-y-3">';
        data.data.forEach(function(p) {
          var viajeLabel = p.id_unidad_viaje
            ? 'Viaje #' + p.id_unidad_viaje + (p.viaje_origen ? ' (' + p.viaje_origen + ' → ' + p.viaje_destino + ')' : '')
            : 'Default (todos los viajes)';

          var statusColor = p.llamadas_activas ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-500';
          var statusLabel = p.llamadas_activas ? 'Activo' : 'Inactivo';

          html += '<div class="border border-gray-200 rounded-lg p-4 hover:border-purple-200 transition-colors">' +
            '<div class="flex items-start justify-between">' +
            '<div class="flex-1">' +
            '<div class="flex items-center gap-2 mb-1">' +
            '<span class="text-sm font-medium text-gray-900">' + viajeLabel + '</span>' +
            '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ' + statusColor + '">' + statusLabel + '</span>' +
            '</div>' +
            '<div class="flex items-center gap-4 text-xs text-gray-500">' +
            '<span>Umbral: ' + (p.umbral_paro_minutos || 30) + ' min</span>' +
            '<span>Idioma: ' + (p.idioma || 'es').toUpperCase() + '</span>' +
            '</div>' +
            (p.protocolo_texto ? '<p class="text-xs text-gray-600 mt-2 bg-gray-50 p-2 rounded">' + p.protocolo_texto.substring(0, 150) + (p.protocolo_texto.length > 150 ? '...' : '') + '</p>' : '') +
            '</div>' +
            '<div class="flex items-center gap-1 ml-3">' +
            '<button onclick="editProtocol(' + p.id + ')" class="p-1.5 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" title="Editar">' +
            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>' +
            '</button>' +
            '<button onclick="deleteProtocol(' + p.id + ')" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Eliminar">' +
            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>' +
            '</button>' +
            '</div>' +
            '</div>' +
            '</div>';
        });
        html += '</div>';
        container.innerHTML = html;
      })
      .catch(function() {
        container.innerHTML = '<div class="text-center text-red-400 py-8">Error cargando protocolos</div>';
      });
  };

  // ===========================================================================
  // Dialog: Protocolo IA
  // ===========================================================================

  var protocolDlg = new ej.popups.Dialog({
    header: 'Protocolo IA',
    content: document.getElementById('protocolDialog'),
    showCloseIcon: true,
    isModal: true,
    width: '560px',
    visible: false,
    animationSettings: { effect: 'Zoom' },
    buttons: [
      {
        buttonModel: { content: 'Guardar', isPrimary: true, cssClass: 'e-primary' },
        click: function() { saveProtocol(); },
      },
      {
        buttonModel: { content: 'Cancelar' },
        click: function() { protocolDlg.hide(); },
      },
    ],
  });
  protocolDlg.appendTo('#protocolDialog');

  var protocolsCache = [];

  window.showProtocolDialog = function(id) {
    document.getElementById('proto-id').value = '';
    document.getElementById('proto-viaje').value = '';
    document.getElementById('proto-umbral').value = '30';
    document.getElementById('proto-llamadas').checked = true;
    document.getElementById('proto-idioma').value = 'es';
    document.getElementById('proto-texto').value = '';

    protocolDlg.header = 'Nuevo protocolo IA';
    protocolDlg.show();
  };

  window.editProtocol = function(id) {
    fetch('/ai/api/protocols')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (!data.success) return;
        var proto = null;
        for (var i = 0; i < data.data.length; i++) {
          if (data.data[i].id === id) { proto = data.data[i]; break; }
        }
        if (!proto) return;

        document.getElementById('proto-id').value = proto.id;
        document.getElementById('proto-viaje').value = proto.id_unidad_viaje || '';
        document.getElementById('proto-umbral').value = proto.umbral_paro_minutos || 30;
        document.getElementById('proto-llamadas').checked = !!proto.llamadas_activas;
        document.getElementById('proto-idioma').value = proto.idioma || 'es';
        document.getElementById('proto-texto').value = proto.protocolo_texto || '';

        protocolDlg.header = 'Editar protocolo #' + proto.id;
        protocolDlg.show();
      });
  };

  window.saveProtocol = function() {
    var body = {
      id: document.getElementById('proto-id').value || undefined,
      id_unidad_viaje: document.getElementById('proto-viaje').value || null,
      umbral_paro_minutos: parseInt(document.getElementById('proto-umbral').value) || 30,
      llamadas_activas: document.getElementById('proto-llamadas').checked,
      idioma: document.getElementById('proto-idioma').value || 'es',
      protocolo_texto: document.getElementById('proto-texto').value || null,
    };

    fetch('/ai/api/protocol', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success) {
        protocolDlg.hide();
        loadProtocols();
        showToast(data.message || 'Protocolo guardado', 'success');
      } else {
        showToast('Error: ' + (data.error || 'Error desconocido'), 'error');
      }
    })
    .catch(function(err) {
      showToast('Error: ' + err.message, 'error');
    });
  };

  window.deleteProtocol = function(id) {
    if (!confirm('¿Eliminar este protocolo? Esta accion no se puede deshacer.')) return;

    fetch('/ai/api/protocol/' + id, { method: 'DELETE' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          loadProtocols();
          showToast('Protocolo eliminado', 'success');
        } else {
          showToast('Error: ' + (data.error || 'Error desconocido'), 'error');
        }
      })
      .catch(function(err) {
        showToast('Error: ' + err.message, 'error');
      });
  };

  // ===========================================================================
  // Stats
  // ===========================================================================

  function loadStats() {
    fetch('/ai/api/stats')
      .then(function(r) { return r.json(); })
      .then(function(data) {
        document.getElementById('stat-ia-active').textContent = data.iaActiveTrips || 0;
        document.getElementById('stat-calls-today').textContent = data.today.total || 0;
        document.getElementById('stat-answered').textContent = data.today.atendidas || 0;
        document.getElementById('stat-unanswered').textContent = data.today.noAtendidas || 0;
        document.getElementById('stat-errors').textContent = data.today.errores || 0;
      })
      .catch(function() {});
  }

  // Refrescar stats cada 30 segundos
  setInterval(loadStats, 30000);

  // ===========================================================================
  // Ejecutar deteccion de paros
  // ===========================================================================

  window.runDetection = function() {
    var btn = document.getElementById('btn-run-detection');
    btn.disabled = true;
    var originalHTML = btn.innerHTML;
    btn.innerHTML = '<svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Analizando...';

    fetch('/ai/api/run-detection', { method: 'POST' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        btn.disabled = false;
        btn.innerHTML = originalHTML;

        if (data.success) {
          loadStats();
          refreshTripsGrid();
          showToast(data.message, data.stops > 0 ? 'info' : 'success');
        } else {
          showToast('Error: ' + (data.error || 'Error desconocido'), 'error');
        }
      })
      .catch(function(err) {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        showToast('Error: ' + err.message, 'error');
      });
  };

  // ===========================================================================
  // Toast notification
  // ===========================================================================

  window.showToast = window.showToast || function(message, type) {
    var colors = {
      success: 'bg-emerald-600',
      error: 'bg-red-600',
      info: 'bg-blue-600',
    };

    var toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 z-50 px-4 py-3 rounded-lg text-white text-sm shadow-lg transition-all duration-300 ' + (colors[type] || colors.info);
    toast.textContent = message;
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(10px)';
    document.body.appendChild(toast);

    requestAnimationFrame(function() {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    });

    setTimeout(function() {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(10px)';
      setTimeout(function() {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 300);
    }, 4000);
  };
})();
</script>
